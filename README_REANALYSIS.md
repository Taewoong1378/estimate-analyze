# 부동산 매물 재평가 시스템 가이드

이 문서는 부동산 매물 분석 프로그램의 재평가 시스템에 대한 상세 설명과 사용법을 제공합니다.

## 재평가 시스템 개요

재평가 시스템은 초기 분석이 완료된 매물들을 전체적으로 비교하여 상대적 순위와 백분율 점수를 산출하는 고급 분석 기능입니다.

### 주요 특징
- **상대적 평가**: 모든 매물을 상호 비교하여 객관적 순위 산출
- **백분율 점수**: 카테고리별 백분율 점수로 명확한 비교 기준 제공
- **배치 처리**: 대량 매물을 효율적으로 처리
- **수렴 알고리즘**: 다중 라운드 재평가로 안정적인 결과 도출

## 재평가 프로세스

### 1. 초기 분석 단계
```bash
python main.py
```
- 개별 매물에 대한 절대적 점수 부여 (100점 만점)
- 결과 저장: `peterpanz_initial_analysis.xlsx`

### 2. 재평가 단계 (자동 실행)
- 초기 분석 완료 후 자동으로 재평가 시작
- 배치 단위 처리 (기본 100개 매물/배치)
- 백분율 점수 계산 및 순위 재조정
- 최종 결과 저장: `peterpanz_analysis_result.xlsx`

## 백분율 점수 시스템

### 계산 방식
각 카테고리별로 전체 매물 중 상대적 위치를 백분율로 표현:

```python
백분율 = (해당 점수보다 낮은 매물 수 + 1) / 전체 매물 수 × 100
```

### 카테고리별 백분율
- **위치 백분율**: 위치 및 접근성 점수 기준
- **건물 백분율**: 건물 및 시설 품질 점수 기준  
- **편의 백분율**: 옵션 및 생활 편의성 점수 기준
- **가격 백분율**: 가격 경쟁력 점수 기준
- **총점 백분율**: 전체 점수 기준

### 종합 백분율 점수
가중 평균을 통한 최종 순위 결정:
```
종합 백분율 = 위치 백분율 × 0.4 + 건물 백분율 × 0.3 + 편의 백분율 × 0.15 + 가격 백분율 × 0.15
```

## 배치 처리 시스템

### 설정 값
- `REANALYSIS_BATCH_SIZE`: 100 (한 번에 처리할 매물 수)
- `NUM_REANALYSIS_ROUNDS`: 5 (재평가 라운드 수)
- `CONVERGENCE_THRESHOLD`: 5.0 (점수 수렴 임계값)

### 처리 흐름
1. **배치 분할**: 전체 매물을 100개 단위로 분할
2. **순차 처리**: 각 배치를 순차적으로 재평가
3. **결과 병합**: 모든 배치 결과를 통합
4. **백분율 계산**: 전체 매물 대상 백분율 점수 산출

## API 최적화 기능

### 속도 제한 준수
- 연속 API 호출 간 최소 2초 지연
- 배치 간 15초 대기 시간
- 할당량 초과 시 자동 대기

### 오류 복구
- JSON 파싱 오류 자동 수정
- 누락된 매물 원본 데이터로 복구
- 최대 3회 재시도

### 로깅 시스템
```
재평가 배치 1/12 처리 중 (100개 매물)...
Gemini API로부터 배치 재평가 결과 수신 (배치 1/12).
재평가 배치 1/12 완료. 100개 결과 추가됨.
15초 대기 후 다음 재평가 배치 처리...
```

## 설정 및 커스터마이징

### 환경 변수
```bash
export GEMINI_API_KEY="your_api_key_here"
```

### 배치 크기 조정
`main.py`에서 설정 변경:
```python
REANALYSIS_BATCH_SIZE = 100  # 배치 크기
```

### 재평가 모델 변경
`gemini_reanalyzer.py`에서 모델 설정:
```python
GEMINI_MODEL_REANALYZER = "gemini-2.5-flash-preview-05-20"
```

## 출력 파일 비교

### 초기 분석 결과 (`peterpanz_initial_analysis.xlsx`)
- 절대적 점수 (0-100점)
- 개별 매물 분석 결과
- 기본 순위 (총점 기준)

### 최종 재평가 결과 (`peterpanz_analysis_result.xlsx`)
- 백분율 점수 (0-100%)
- 상대적 순위
- 종합 백분율 점수 기준 정렬
- 재평가 메타데이터 포함

## 성능 및 비용

### 처리 시간
- 1,200개 매물 기준: 약 20-30분
- 배치당 평균 2-3분 소요
- API 응답 속도에 따라 변동

### API 비용
- 재평가 단계에서 추가 API 호출 발생
- 배치당 약 1-2회 API 호출
- 전체 비용은 매물 수에 비례

## 문제 해결

### 일반적인 오류

1. **API 할당량 초과**
   ```
   할당량 제한 (배치 X/Y). 60초 후 재시도.
   ```
   - 자동으로 대기 후 재시도
   - 필요시 배치 크기 감소

2. **JSON 파싱 오류**
   ```
   JSON 파싱 오류 발생: 자동 수정 시도 중...
   ```
   - 자동 수정 로직 적용
   - 수정 실패 시 기본값 사용

3. **매물 누락**
   ```
   재평가 과정에서 5개 매물이 누락되었습니다.
   ```
   - 누락된 매물은 초기 분석 결과 사용
   - 최종 결과에 자동 포함

### 로그 확인
상세한 처리 과정은 콘솔 로그에서 확인 가능:
```bash
python main.py 2>&1 | tee analysis.log
```

## 고급 사용법

### 재평가만 별도 실행
초기 분석이 이미 완료된 경우, 재평가 로직만 별도로 실행하려면 `gemini_reanalyzer.py`를 직접 사용할 수 있습니다:

```python
from gemini_reanalyzer import reanalyze_property_batch, calculate_percentile_scores
import pandas as pd

# 기존 분석 결과 로드
df = pd.read_excel('peterpanz_initial_analysis.xlsx')
properties = df.to_dict('records')

# 재평가 실행
reanalyzed = reanalyze_property_batch(properties, api_key, "1", "1")
```

### 백분율 점수만 계산
API 없이 백분율 점수만 계산:
```python
from gemini_reanalyzer import calculate_percentile_scores

# 백분율 점수 계산
properties_with_percentiles = calculate_percentile_scores(properties)
```

## 주의사항

- 재평가는 전체 매물을 대상으로 하므로 매물 수가 적으면 의미가 제한적
- API 키가 없으면 백분율 계산만 수행
- 대량 매물 처리 시 충분한 메모리와 안정적인 네트워크 필요
- 재평가 중단 시 초기 분석 결과를 최종 결과로 사용 